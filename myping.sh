#!/bin/bash
#
# Mario Arturo Perez Rangel
#
# Basado en el tiempo de vida (TTL) que los host definen
# en los paquetes de respuesta, se trata de deducir el sistema
# operativo.
#

PATH=/usr/bin

#
# Seguimos solo si hay un host a consultar
#
if [ $# != 1 ]
then
    echo "Debe dar el nombre o ip de un host."
    exit -1
fi

# Enviar un solo ping con tiempo de espera 5 segundos para no
# esperar demasiado tiempo. Filtramos solo la linea con la respuesta
#
RES=`ping -c 1 -W 5 $1 | grep ttl`

#
# No hubo respuesta? termina
#
if [ "$RES" == "" ]
then
    echo "No hubo respuesta del host."
    exit -2
fi

#
# Filtramos solo el valor numerico del ttl
#
TTL=`echo $RES | sed s/^.*ttl=// | sed s/^\\\\\([0-9]\\\+\\\\\).*$/\\\1/`

#
#  Linux responde asignado un ttl de 64 a los paquetes.
#  Windows responde asignado un ttl de 128 a los paquetes.
#  Solaris/AIX responde asignado un ttl de 255 a los paquetes.
#
if [ $(($TTL >= 60)) -a  $(($TTL <= 64)) ]
then
    echo "El S.O. parece ser un *nix/Linux."
fi

if [ $(($TTL >= 120)) -a  $(($TTL <= 128)) ]
then
    echo "El S.O. parece ser un Windows."
fi

if [ $(($TTL >= 129)) -a  $(($TTL <= 255)) ]
then
    echo "El S.O. parece ser un Solaris o un AIX."
else
    echo "Ignoro que tipo de S.O. se trata."
fi
