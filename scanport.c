/*
 * Mario Arturo Perez Rangel
 * 15-03-2017
 *
 * El programa trata de crear una conexion a un servidor por el puerto indicado.
 * Si consigue conectarse el puerto esta abierto, en caso contrario se reporta como
 * cerrado.
 *
 * El programa puede manejar un rango de puertos para analizar y por cada uno de ellos
 * crea un socket y trata de conectarse a traves de dicho socket, reportando cada puerto
 * como se especifica en el parrafo anterior.
 */

#include "enumerasmtp.h"

int main(int argc, char *argv[])
{
  char ip[MAX_DATA_SIZE];
  int pto_min, pto_max, puerto, aux;
  int sp;
  struct sockaddr_in serv_addr; // Informacion sobre la direccion del servidor
  struct hostent *server;

  /**
   ** Manejo de las opciones
   **/
  pto_max = -1;
  if ((argc < 3) || (argc > 4) ) {
    error("Uso: scanport <ip> <puerto_inicio> [puerto_final]\n\n");
    error("La forma mas simple es:\n\t scanport 127.0.0.1 22\n\n");
    error("Se puede escanear un rango de puertos de la siguiente manera: \n");
    error("\tscanport 127.0.0.1 22 80\n\n");
    exit(1);
  }

  /* Direccion ip y puerto a escanear */
  if (argc == 3) {
    sscanf(argv[1], "%15s[0-9.]", ip);
    sscanf(argv[2], "%d", &pto_min);
    pto_max = pto_min;

    /* Direccion ip y rango de puertos a escanear */
  } else {
    if (argc == 4) { 
      sscanf(argv[1], "%15s[0-9.]", ip);
      sscanf(argv[2], "%d", &pto_min);
      sscanf(argv[3], "%d", &pto_max);
    }
  }
  if ((pto_max <= 0) || (pto_min <= 0)) {
    error("Los puertos no pueden ser numeros negativos.\n\n");
    exit (-1);
  }
  if (pto_max < pto_min) {
    aux = pto_max;
    pto_max = pto_min;
    pto_min = aux;
  }

  /**
   ** Comenzamos a revisar el rango de puertos
   **/
  if ((server = gethostbyname(ip)) == NULL) {
    error("La direccion ip no es valida.\n");
    exit(-1);
  }

  printf ("Analisis de puertos escaneados para la direccion:\n%s:\n", ip);
  
  for(puerto = pto_min; puerto <= pto_max; puerto++) {

    if ((sp = socket(AF_INET, SOCK_STREAM, 0))< 0) {
      error("No fue posible crear el socket.");
      exit(-1);
    }

    bzero((char *)&serv_addr, sizeof(serv_addr)); // Limpiamos la variable
    serv_addr.sin_family = AF_INET; //  Direcciones IP v4
    bcopy((char *)server->h_addr, (char *)&serv_addr.sin_addr.s_addr,
	  server->h_length);
    serv_addr.sin_port = htons(puerto);

    /* Intentamos la conexion con el servidor */
    if (connect(sp,(struct sockaddr *) &serv_addr, sizeof(serv_addr)) < 0) {
      printf ("%5d\tCerrado\n", puerto);
    } else {
      printf ("%5d\tAbierto\n", puerto);
    }
    close (sp);
  }
  exit(0);
}


/*
 * Muestra el mensaje de error contenido en msg.
 */
void error(char *msg)
{
  fprintf(stderr, "%s", msg);
}
